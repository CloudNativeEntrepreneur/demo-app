buildPack: docker-helm
pipelineConfig:
  agent:
    image: gcr.io/jenkinsxio/builder-go
    label: jenkins-go
  env:
  - name: DOCKER_CONFIG
    value: /home/jenkins/.docker/
  - name: DOCKER_REGISTRY
    valueFrom:
      configMapKeyRef:
        key: docker.registry
        name: jenkins-x-docker-registry
  - name: GIT_AUTHOR_EMAIL
    value: jenkins-x@googlegroups.com
  - name: GIT_AUTHOR_NAME
    value: jenkins-x-bot
  - name: GIT_COMMITTER_EMAIL
    value: jenkins-x@googlegroups.com
  - name: GIT_COMMITTER_NAME
    value: jenkins-x-bot
  - name: JENKINS_URL
    value: http://jenkins:8080
  - name: LOAD_TEST_USERS
    value: '1000'
  - name: LOAD_TEST_RAMP_DURATION
    value: 5m
  - name: LOAD_TEST_FULL_LOAD_DURATION
    value: 10m
  pipelines:
    pullRequest:
      promote:
        steps:
        - dir: charts/preview
          steps:
          - sh: env
            name: debug-env
          - sh: make preview
            name: preview-setup
          - sh: jx preview --app $APP_NAME --dir ../..
            name: preview
          - sh: PREVIEW_URL=https://$REPO_NAME-jx-$(echo $REPO_OWNER | tr '[:upper:]' '[:lower:]' )-$REPO_NAME-pr-$PULL_NUMBER.cloudnativeentrepreneur.dev sh ./load-test.sh
            name: load-test
